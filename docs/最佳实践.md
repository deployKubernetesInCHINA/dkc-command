最佳实践
--
#### 故事: 安装人员利用装机小能手koictl快速稳定的在centos7服务器上安装一套k8s/mongo基础环境和opsapps

##### 基础环境安装演示

###### 服务器列表
os: centos7

用户名密码: root/Root
  - 10.184.101.240
  - 10.184.101.241
  - 10.184.101.242
  - 10.184.101.243

###### 一 准备阶段 (支持linux/windows/macos)

1. 访问https://devops.bizconf.cn/inventory-builder/ 下载koictl
2. 首先替换当前目录下的服务升级模板zip文件bizcloudenterprise-*.zip, 执行下载命令,包含cache和surpass
   ```shell script
   ./koictl-linux-amd64 download all 
   ```
3. 编辑下载拓扑文件hosts.yaml, 替换掉inventory/hosts.yaml

###### 二 安装阶段

4. 通过U盘等方式将安装文件移动到任意一个服务器上,执行部署

   ```shell script
   ./koictl-linux-amd64 install base
   ./koictl-linux-amd64 install surpass
   ```
5. 本地添加ops域名解析. 在surpass opsconsole页面上使用新生成的surpass_bizcloud/bizcloudenterprise-*.zip进行安装
###### 三 k8s集群增删节点

1. 增加节点

    ```shell script
    ./koictl-linux-amd64 node add --hostname surpass-worker-2 --ip 192.168.57.3
    ```

2. 删除节点
    ```shell script
    ./koictl-linux-amd64 node del --hostname surpass-worker-2
    ```
   
###### 四 surpass集群升级

1. 下载替换项目根目录下的bizcloudenterprise-*.zip
2. 下载surpass镜像文件和chart. 
   download-surpass命令会在surpass_bizcloud目录生成新的升级zip包
    ```shell script
    ./koictl-linux-amd64 download surpass
    ```
3. 升级surpass, 上传镜像文件和chart到k8s集群私有仓库
    ```shell script
    ./koictl-linux-amd64 upgrade surpass
    ```
4. 在surpass opsconsole页面上使用surpass_bizcloud/bizcloudenterprise-*.zip进行升级


###### 五 k8s集群升级
1. 保存hosts.yaml
    ```shell script
    cp ~/koictl/inventory/hosts.yaml ~/
    ```

2. 下载最新koictl.tar.gz, 下载最新cache
    ```shell script
    tar xf koictl.tar.gz
    cd koictl
    cp ~/hosts.yaml inventory/
    ./koictl-linux-amd64 download cache
    ```
3. 升级k8s
    ```shell script
    ./koictl-linux-amd64 upgrade k8s
    ```
